# Custom Auth System

Это backend-приложение на FastAPI, реализующее собственную систему аутентификации (JWT) и авторизации (RBAC) без использования встроенных инструментов фреймворка «из коробки».

## 1. Архитектура системы доступа

В основе системы лежит гибкая структура управления правами, состоящая из четырех логических таблиц:

Схема сущностей

- Users: Учетные записи. Содержат password_hash (bcrypt) и флаг is_active для реализации «мягкого» удаления.

- Roles: Справочник ролей (например: админ, пользователь).

- Business Elements: Объекты системы, к которым ограничивается доступ (например: products, admin_panel).

- Access Role Rules: Таблица соответствия «Роль — Элемент — Действие». Определяет права (Boolean) на чтение, создание, обновление и удаление.

## 2. Матрица прав доступа 

Текущая конфигурация в mock_db.py настроена следующим образом:

| Роль         	| Элемент     	| Действие 	| Результат         	|
|--------------	|-------------	|----------	|-------------------	|
| Админ        	| admin_panel 	| read_all 	| ✅ Доступ разрешен 	|
| Админ        	| products    	| read_all 	| ✅ Доступ разрешен 	|
| Пользователь 	| products    	| read_all 	| ✅ Доступ разрешен 	|
| Пользователь 	| admin_panel 	| read_all 	| ❌ 403 Forbidden   	|

## 3. Функциональные возможности

### Аутентификация

- Регистрация: Создание пользователя с хешированием пароля через bcrypt. По умолчанию присваивается роль «пользователь».

- Login: Проверка учетных данных и выдача JWT (JSON Web Token).

- Logout: Реализован на стороне клиента (удаление токена из localStorage). Сервер предоставляет эндпоинт для подтверждения выхода.

- Мягкое удаление: При удалении аккаунта флаг is_active переходит в False. Пользователь остается в базе, но не может пройти авторизацию (401).

### Авторизация (RBAC)

Доступ к ресурсам проверяется кастомной зависимостью PermissionChecker. Она сопоставляет роль текущего пользователя с правами, прописанными для запрашиваемого бизнес-элемента.

## 4. Структура проекта

main.py — Точка входа, маршруты и обработка HTML-представлений.

security.py — Логика работы с JWT, хеширование паролей и зависимости (Depends).

schemas.py — Pydantic-модели для строгой валидации входящих данных.

mock_db.py — Имитация базы данных (In-memory storage).

templates/ — HTML-страницы (регистрация, вход, страницы ошибок 401 и 403).

## 5. Установка и запуск

Установите необходимые зависимости:

`pip install fastapi uvicorn PyJWT bcrypt jinja2 python-multipart`

Запустите сервер:

`uvicorn main:app --reload`

Использование:

Регистрация нового пользователя: `http://127.0.0.1:8000/register`

Вход в систему: `http://127.0.0.1:8000/login`

Данные администратора для теста: admin@example.com / admin123

## 6. Обработка ошибок

401 Unauthorized: Возвращается, если токен отсутствует, невалиден или пользователь деактивирован.

403 Forbidden: Возвращается, если у роли пользователя нет прав на чтение/редактирование конкретного бизнес-элемента.
